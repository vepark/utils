/* Step 1: Create a list of Excel files in a directory */
filename filelist pipe 'ls /path/to/your/excel/files/*.xlsx';

/* Step 2: Read the list and process each file */
data _null_;
    length fname $256;
    infile filelist truncover;
    input fname $256.;
    call execute('%process_file("/path/to/your/excel/files/' || trim(fname) || '")');
run;

%macro process_file(filepath);
    /* Extract the base filename without extension and the 4-digit number */
    %let filename = %scan(&filepath, -1, '/');
    %let filename = %substr(&filename, 1, %length(&filename)-5); /* Remove .xlsx extension */
    %let fileNum = %substr(&filename, %eval(%length(&filename)-3), 4);

    /* Define a macro variable to collect datasets for appending */
    %let datasets_to_append = ;

    /* Loop through the specified tab numbers, importing with different ranges for 301 */
    %do tab = 301 %to 320;
        %let range = %if &tab = 301 %then C:G; %else C:D; /* Determine the range based on the tab number */
        %let outName = DAQ&fileNum.&tab; /* Construct the output dataset name */

        /* PROC IMPORT for the current sheet with dynamic range */
        proc import datafile="&filepath"
            out=work.imported&tab /* Temporarily store imported data with tab number */
            dbms=xlsx
            replace;
            sheet="&tab"; /* Specify sheet name dynamically */
            range="&range"; /* Use the determined range */
            getnames=yes; 
        run;

        /* Filter data immediately after import */
        data &outName;
            set work.imported&tab;
            if &tab = 301 then do;
                if missing(cats(of _all_)) or substr(C, length(C), 1) NE ':' then delete;
            end;
            else do;
                if missing(cats(of _all_)) then delete;
            end;
        run;

        /* Keep track of datasets for appending */
        %let datasets_to_append = &datasets_to_append &outName;
    %end;

    /* Append datasets after processing all sheets */
    %append_data(&fileNum);
%mend process_file;

%macro append_data(fileNum);
    data combined_&fileNum;
        retain SheetName C D;
        length SheetName $32 C $100 D $100;
        %do i = 301 %to 320;
            set DAQ&fileNum.&i indsname=src;
            SheetName = src;
            if substr(C,1,5) = "Note:" then delete;
            if substr(compress(D),1,1)='[' or substr(compress(D),-1) = ']' then D = '';
            if D="PASS NA" or D="YES NO" then D= ' ';
        %end;
    run;
%mend append_data;
