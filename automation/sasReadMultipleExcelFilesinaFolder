/* Step 1: Create a list of Excel files in a directory */
filename filelist pipe 'ls /path/to/your/excel/files/*.xlsx';

/* Step 2: Read the list and process each file */
data _null_;
    length fname $256;
    infile filelist truncover;
    input fname $256.;
    call execute('%process_file("/path/to/your/excel/files/' || trim(fname) || '")');
run;

%macro process_file(filepath);
    /* Extract the 4-digit number and base filename */
    %let filename = %scan(&filepath, -1, '/');
    %let filename = %substr(&filename, 1, %length(&filename)-5); /* Remove extension */
    %let fileNum = %substr(&filename, %eval(%length(&filename)-3), 4);

    /* Loop through the specified tab numbers */
    %do tab = 301 %to 320;
        /* Correctly use %if to set the range */
        %if &tab = 301 %then %let range = C:G;
        %else %let range = C:D;

        %let outName = DAQ&fileNum.&tab; /* Dynamic dataset name based on file and tab */

        /* PROC IMPORT with the corrected range */
        proc import datafile="&filepath"
            out=work.imported&tab
            dbms=xlsx
            replace;
            sheet="&tab"; /* Use tab number as sheet name */
            range="&range"; 
            getnames=yes;
        run;

        /* Data step for conditional row deletion */
        data &outName;
            set work.imported&tab;
            if &tab = 301 then do;
                if missing(cats(of _all_)) or substr(C, length(C), 1) NE ':' then delete;
            end;
            else do;
                if missing(cats(of _all_)) then delete;
            end;
        run;

        /* Append to list for further processing */
        %let datasets_to_append = &datasets_to_append &outName;
    %end;

    /* Call to append and clean datasets */
    %append_data(&fileNum);
%mend process_file;

%macro append_data(fileNum);
    data combined_&fileNum;
        retain SheetName C D;
        length SheetName $32 C $100 D $100;
        %do i = 301 %to 320;
            set DAQ&fileNum.&i indsname=src;
            SheetName = src;
            if substr(C,1,5) = "Note:" then delete;
            if substr(compress(D),1,1)='[' or substr(compress(D),-1) = ']' then D = '';
            if D="PASS NA" or D="YES NO" then D= ' ';
        %end;
    run;
%mend append_data;
