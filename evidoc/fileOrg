/* Ensure any prior filename assignments are cleared */
filename dirlist clear;
filename filelist clear;

/* Define the pipe to list directories */
filename dirlist pipe "find /path/to/search/root -type d -name 'INPUT' -print";

data dir_info;
    length full_path $256;
    infile dirlist truncover;
    input full_path $char256.;
    retain red_folder_name input_path;

    if index(upcase(full_path), '/RED') then do;
        red_folder_name = scan(full_path, -3, '/');
        input_path = full_path;
        if upcase(scan(red_folder_name, 1, '/')) =: 'RED' then output;
    end;
run;

/* Process each directory and list filenames */
data want(drop=i rc);
    set dir_info;
    length file_list $32767;
    retain file_list;
    
    by red_folder_name;
    if first.red_folder_name then file_list = '';

    /* Use a data step loop to safely process files */
    d = dopen('dirlist');
    do i = 1 to dnum(d);
        fname = dread(d, i);

        if not missing(fname) then
            file_list = catx(',', file_list, fname);

        /* Close file loop and output */
        if last.red_folder_name then do;
            input_subfolder_filenames = file_list;
            output;
        end;
    end;
    dclose(d);

    filename filelist clear;
run;

proc print data=want noobs;
run;
