%macro processExcelFiles(directory);
    %local fileref rc filename i;
    %let fileref = dirlist;
    
    /* Assign a directory list fileref */
    filename dirlist "&directory";
    
    /* Open the directory and read filenames */
    %let did = %sysfunc(dopen(&fileref));
    %if &did > 0 %then %do;
        %do i = 1 %to %sysfunc(dnum(&did));
            %let filename = %sysfunc(dread(&did, &i));
            /* Filter for Excel files */
            %if %upcase(%sysfunc(prxmatch(/\.xlsx$/, &filename))) > 0 %then %do;
                %processFile(directory=&directory, filename=&filename);
            %end;
        %end;
        %let rc = %sysfunc(dclose(&did));
    %end;
    %else %do;
        %put ERROR: Unable to open directory &directory.;
    %end;
    
    filename dirlist clear;
%mend;

%macro processFile(directory, filename);
    %local libref;
    %let libref = excel;

    /* Setup libname to point to the Excel file */
    libname &libref xlsx "&directory.&filename";

    /* Retrieve prefix from the Summary sheet, assuming cell B2 contains the prefix */
    %local prefix;
    %if %sysfunc(exist(&libref.'Summary$'n)) %then %do;
        proc sql noprint;
            select put(B2, $20.) into :prefix
            from &libref.'Summary$'n(obs=1);
        quit;
    %end;
    %else %do;
        %let prefix = %substr(&filename, 1, %length(&filename)-5); /* Use filename as prefix if Summary not found */
    %end;

    /* Process each sheet */
    proc sql noprint;
        select memname into :sheets separated by ' '
        from dictionary.tables
        where libname = upcase("&libref") and (memname like: '___');
    quit;

    /* Import and rename sheets */
    %do i = 1 %to &sqlobs;
        %let sheet = &&sheets&i;
        data &&prefix._&&sheet;
            set &libref..&&sheet (keep=%if(&&sheet = '301') %then %do;C--G%end; %else %do;C D%end;);
        run;
    %end;

    /* Combine sheets */
    data &prefix._combined;
        set &prefix.:;
    run;

    libname &libref clear;
%mend;

/* Call the macro with your directory */
%processExcelFiles(C:\path\to\your\excel\files\);
