%macro processExcelFiles(directory);
    %local fileref did filename i;
    %let fileref = dirlist;

    filename &fileref "&directory";
    %let did = %sysfunc(dopen(&fileref));

    %if &did %then %do;
        %let i = 1;
        %let filename = %sysfunc(dread(&did, &i));
        %do %while(&filename ne '');
            %if %upcase(%sysfunc(prxmatch(/\.xlsx$/, &filename))) > 0 %then %do;
                %processFile(directory=&directory, filename=&filename);
            %end;
            %let i = %eval(&i + 1);
            %let filename = %sysfunc(dread(&did, &i));
        %end;
        %let rc = %sysfunc(dclose(&did));
    %end;
    %else %do;
        %put ERROR: Unable to open directory: &directory.;
    %end;

    filename &fileref clear;
%mend;

%macro processFile(directory, filename);
    %local libname filepath prefix sheet nSheets;
    %let libname = work;  /* Using the work library for temporary storage */
    %let filepath = "&directory&filename";

    libname &libname xlsx "&filepath";

    /* Retrieve prefix from the Summary sheet's B2 cell, if it exists */
    %if %sysfunc(exist(&libname.'Summary$'n)) %then %do;
        proc sql noprint;
            select put(B2, $20.) into :prefix trimmed from &libname.'Summary$'n;
        quit;
    %end;
    %else %do;
        %let prefix = NoPrefix; /* Default if no Summary or B2 is empty */
    %end;

    /* Import and process sheets */
    proc sql noprint;
        select memname into :sheets separated by ' ' from dictionary.tables
        where libname = "&libname" and (memname like '___' or memname = 'Summary$');
    quit;

    %let nSheets = %sysfunc(countw(&sheets));

    %do i = 1 %to &nSheets;
        %let sheet = %scan(&sheets, &i);
        %let range = %if(&sheet = '301') %then C--G %else C--D;

        data &prefix._&sheet;
            set &libname..&sheet (keep=&range);
        run;
    %end;

    /* Combine relevant sheets into one dataset */
    data &prefix._combined;
        set &prefix._:;
    run;

    libname &libname clear;
%mend;

/* Specify your directory containing Excel files */
%processExcelFiles(/path/to/your/excel/files/);
