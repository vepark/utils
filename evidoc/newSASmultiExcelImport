%macro processExcelFiles(directory);
    %let fileref = dirlist;
    filename &fileref "&directory";
    %let did = %sysfunc(dopen(&fileref));

    %if &did %then %do;
        %do i = 1 %to %sysfunc(dnum(&did));
            %let filename = %sysfunc(dread(&did, &i));
            /* Filter for Excel files */
            %if %upcase(%sysfunc(prxmatch(/\.xlsx$/, &filename))) > 0 %then %do;
                %processFile(directory=&directory, filename=&filename);
            %end;
        %end;
        %let rc = %sysfunc(dclose(&did));
    %end;
    %else %put ERROR: Unable to open directory: &directory.;
    
    filename &fileref clear;
%mend;

%macro processFile(directory, filename);
    %let libname = excel;
    %let filepath = "&directory&filename";
    
    libname &libname xlsx &filepath;

    /* Get the prefix from the Summary sheet's B2 cell, if it exists */
    %if %sysfunc(exist(&libname.'Summary$'n)) %then %do;
        proc sql noprint;
            select put(B2, $20.) into :prefix trimmed
            from &libname.'Summary$'n;
        quit;
    %end;
    %else %do;
        %let prefix = %sysfunc(propcase(%qscan(&filename, -2, .)));
    %end;

    /* Import and process sheets */
    proc sql noprint;
        create table work.sheets as
        select memname
        from dictionary.tables
        where libname = "&libname" and (memname like: '___' or memname = 'Summary$');
    quit;

    %let nSheets = %sysfunc(attrn(work.sheets, nlobs));

    %do i = 1 %to &nSheets;
        %let sheet = %scan(&sheets, &i);
        %if &sheet = '301' %then %do;
            %let range = C--G;
        %end;
        %else %do;
            %let range = C--D;
        %end;

        data &prefix._&sheet;
            set &libname..&sheet (keep=&range);
        run;
    %end;

    libname &libname clear;
%mend;

/* Specify the directory path using forward slashes */
%processExcelFiles(/path/to/your/excel/files/);
