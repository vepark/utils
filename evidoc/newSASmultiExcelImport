%macro processExcelFiles(directory);
    %local fileref did filename i rc;
    %let fileref = dirlist;

    filename &fileref "&directory";
    %let did = %sysfunc(dopen(&fileref));

    %if &did %then %do;
        %do %while (%sysfunc(dread(&did, &i, filename)) ne '');
            %if %upcase(%sysfunc(prxmatch(/\.xlsx$/, &filename))) > 0 %then %do;
                %processFile(directory=&directory, filename=&filename);
            %end;
            %let i = %eval(&i + 1);
        %end;
        %let rc = %sysfunc(dclose(&did));
    %end;
    %else %do;
        %put ERROR: Unable to open directory: &directory.;
    %end;

    filename &fileref clear;
%mend;

%macro processFile(directory, filename);
    %local libname filepath prefix sheet range;
    %let libname = excel;
    %let filepath = "&directory&filename";

    libname &libname xlsx "&filepath";

    /* Retrieve prefix from Summary if it exists */
    %if %sysfunc(exist(&libname.'Summary$'n)) %then %do;
        proc sql noprint;
            select put(B2, $20.) into :prefix trimmed from &libname.'Summary$'n;
        quit;
    %end;
    %else %do;
        %let prefix = NoPrefix; /* Default if no Summary or B2 is empty */
    %end;

    /* Process sheets */
    proc sql noprint;
        select memname into :sheets separated by ' ' from dictionary.tables
        where libname = "&libname" and (memname like: '___' or memname = 'Summary$');
    quit;

    %do i = 1 %to %sysfunc(countw(&sheets));
        %let sheet = %scan(&sheets, &i);
        %if &sheet = '301' %then %do;
            %let range = C--G;
        %end;
        %else %do;
            %let range = C--D;
        %end;

        data &prefix._&sheet;
            set &libname..&sheet (keep=&range);
        run;
    %end;

    /* Combine sheets if required */
    data &prefix._combined;
        set &prefix.:;
    run;

    libname &libname clear;
%mend;

/* Example usage */
%processExcelFiles(/path/to/your/excel/files/);
