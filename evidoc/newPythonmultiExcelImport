import os
import pandas as pd
from openpyxl import load_workbook

def process_excel_files(directory):
    for filename in os.listdir(directory):
        if filename.endswith('.xlsx'):
            filepath = os.path.join(directory, filename)
            try:
                process_file(filepath)
            except Exception as e:
                print(f"Error processing {filename}: {e}")

def process_file(filepath):
    wb = load_workbook(filepath)
    prefix = get_prefix(wb)
    
    combined_data = pd.DataFrame()
    for sheet_name in wb.sheetnames:
        if sheet_name.isdigit() and len(sheet_name) == 3:
            try:
                df = pd.read_excel(filepath, sheet_name=sheet_name, engine='openpyxl')
                # Debug print to check the columns in the loaded DataFrame
                print(f"Columns in {sheet_name}: {df.columns.tolist()}")

                # Define columns based on sheet number
                columns_to_keep = ['C', 'D', 'E', 'F', 'G'] if sheet_name == '301' else ['C', 'D']
                # Check if the necessary columns exist in the DataFrame
                if not set(columns_to_keep).issubset(df.columns):
                    raise ValueError(f"Required columns {columns_to_keep} are not all present in sheet {sheet_name}")

                df = df[columns_to_keep]
                df['SheetName'] = prefix + '_' + sheet_name
                combined_data = pd.concat([combined_data, df], ignore_index=True)

            except Exception as e:
                print(f"Error processing sheet {sheet_name} in {os.path.basename(filepath)}: {e}")

    # Save the combined data to a new Excel file
    output_filepath = os.path.join(os.path.dirname(filepath), prefix + '_combined.xlsx')
    combined_data.to_excel(output_filepath, index=False)
    print(f'Combined data saved to {output_filepath}')

def get_prefix(wb):
    try:
        summary_sheet = wb['Summary']
        prefix = summary_sheet['B2'].value
        return str(prefix) if prefix else 'NoPrefix'
    except KeyError:
        return 'NoSummarySheet'

# Example usage
directory_path = '/path/to/your/excel/files'
process_excel_files(directory_path)
