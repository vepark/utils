import os
import pandas as pd
from openpyxl import load_workbook

def process_excel_files(directory):
    for filename in os.listdir(directory):
        if filename.endswith('.xlsx'):
            process_file(os.path.join(directory, filename))

def process_file(filepath):
    wb = load_workbook(filepath)
    prefix = get_prefix(wb)
    
    combined_data = pd.DataFrame()
    for sheet_name in wb.sheetnames:
        if sheet_name.isdigit() and len(sheet_name) == 3:
            df = pd.read_excel(filepath, sheet_name=sheet_name, engine='openpyxl')
            if sheet_name == '301':
                df = df[['C', 'D', 'E', 'F', 'G']]  # Specify the columns for sheet 301
            else:
                df = df[['C', 'D']]  # Specify the columns for other numbered sheets
            df['SheetName'] = prefix + '_' + sheet_name  # Rename the sheet
            combined_data = pd.concat([combined_data, df], ignore_index=True)
    
    # Save the combined data to a new Excel file
    output_filepath = os.path.join(os.path.dirname(filepath), prefix + '_combined.xlsx')
    combined_data.to_excel(output_filepath, index=False)
    print(f'Combined data saved to {output_filepath}')

def get_prefix(wb):
    try:
        summary_sheet = wb['Summary']
        prefix = summary_sheet['B2'].value
        return str(prefix) if prefix else 'NoPrefix'
    except KeyError:
        return 'NoSummarySheet'

# Example usage
directory_path = '/path/to/your/excel/files'
process_excel_files(directory_path)
