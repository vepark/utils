%macro importSheetsDAQ3(file_path, last4);
    /* Ensure last4 is received correctly */
    %put &=last4; /* Debugging: Print last4 to log */
    
    /* Import 'Summary' sheet */
    proc import datafile="&file_path" out=work.temp_summary dbms=xlsx replace;
        sheet="Summary";
    run;

    /* Correct naming convention with last4 resolved */
    data REDA_&last4._Summary;
        set work.temp_summary;
    run;

    /* Loop through sheets 301 to 320, with specific logic for sheet 310 */
    %do i=301 %to 320;
        %let sheet_name = %str(&i);
        %if &i = 310 %then %do;
            proc import datafile="&file_path" out=work.temp310 dbms=xlsx replace;
                sheet="&sheet_name" range="C:G";
            run;
            data REDA_&last4._&sheet_name;
                set work.temp310;
                if cmiss(of _all_) or substr(C, length(C)) = ':' then delete;
            run;
        %end;
        %else %do;
            proc import datafile="&file_path" out=work.temp_others dbms=xlsx replace;
                sheet="&sheet_name" range="C:D";
            run;
            data REDA_&last4._&sheet_name;
                set work.temp_others;
            run;
        %end;
    %end;
%mend importSheetsDAQ3;

%macro importAllSheets(directory);
    /* Get the list of all xlsx files and extract a four-digit number from anywhere in the filename */
    filename _dir_ "&directory";
    data file_list(keep=filename last4);
        length filename $256. last4 $4.;
        dir_id = dopen('_dir_');
        if dir_id > 0 then do;
            file_num = dnum(dir_id);
            do i = 1 to file_num;
                filename = dread(dir_id, i);
                if lowcase(scan(filename, -1, '.')) = 'xlsx' then do;
                    /* Use a regex to find the first occurrence of a four-digit number */
                    if prxmatch("/(\d{4})/", filename) > 0 then last4 = prxposn(prxparse("/(\d{4})/"), 1, filename);
                    else last4 = "0000";
                    output;
                end;
            end;
        end;
        rc = dclose(dir_id);
    run;

    /* Process each file using call execute */
    proc sql noprint;
        select catx(' ', '%importSheetsDAQ3(', quote(trim(directory)) || '/' || trim(filename), ',', last4, ')') into :exec_list separated by ';'
        from file_list;
    quit;

    /* Execute each macro call for processing files */
    %do i = 1 %to &sqlobs;
        %let exec_call = %scan(&exec_list, &i, ';');
        %put &exec_call; /* Debugging: Print each call to log */
        &exec_call.;
    %end;
%mend importAllSheets;

/* Call the master macro */
%importAllSheets(/path/to/your/xlsx/files);
